---
title: "South Sudan's Conflict Context"
subtitle: "Exploring ACLED's Event Database" 
author: "Brian Calhoon"
date: "05/23/2021"
output: 
  bookdown::html_document2:
    fig.caption: T
    toc: true
    toc_depth: '5'
    toc_float: yes
    code_folding: hide
    
---
<style>
TOC {border-color: #133469;

}

body{font-family: Corbel;
     font-size: 18px;
     background-color: #FDFDFD;
}

h1{color: #133469; 
}

h2{color: #009CA6;
}

h3{color: #5482AB;
}

p.caption{
font-size: small;
}

</style>
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, cache = T, error = T)

```

```{r, include = FALSE, eval = TRUE}
#load packages
source("prep/packages_fonts_styles.R", local = knitr::knit_global())

```
# Conflict Across South Sudan

```{r download ACLED data, include = F}
#The data
events <- read_xlsx("data/SSudan.xlsx") 


events$admin1 <- events$admin1 %>% 
  recode("Western Bahr El Ghazal" = "Western Bahr el Ghazal")

#This version has a geometry column added to it
events_sf <- st_as_sf(events, coords = c("longitude", "latitude"), crs = 4326)
```

```{r, include = F}

#shape files for neighboring countries
neighbors <- geoboundaries(country = c("Uganda", "Kenya", "Sudan", "Ethiopia", "Central African Republic", "Democratic Republic of the Congo", "South Sudan"))

# Shape file for The border of South Sudan
SSudan <- geoboundaries(country = "South Sudan")

#shape files for the counties of South Sudan
states <- geoboundaries(country = "South Sudan"
                        , adm_lvl = "adm1")




#Get the crs
crsuggest::suggest_crs(SSudan) #This is a suggested crs for South Sudan, 21096

crs <- 21096

SSudan <- st_transform(SSudan, crs = crs)

bbox <- st_bbox(SSudan) #established the bounding box coordinates

#shape files for neighboring countries
neighbors <- geoboundaries(country = c("Uganda", "Kenya", "Sudan", "Ethiopia", "Central African Republic", "Democratic Republic of the Congo", "South Sudan")) 

neighbors_v1 <- st_transform(neighbors, crs)
# Shape file for The border of South Sudan
SSudan <- geoboundaries(country = "South Sudan") %>% st_transform(crs = crs)



events_sf <- st_transform(events_sf, crs = crs)
#shape files for the counties of South Sudan
states <- geoboundaries(country = "South Sudan"
                        , adm_lvl = "adm1") %>% 
  st_transform(crs = crs)

#shape files for the districts of South Sudan
districts <- geoboundaries(country = "South Sudan"
                           , adm_lvl = "adm2") %>% 
  st_transform(crs = crs)

#shape files for the counties of South Sudan
states <- geoboundaries(country = "South Sudan"
                        , adm_lvl = "adm1") %>% 
  st_transform(crs = crs)

#shape files for the districts of South Sudan
districts <- geoboundaries(country = "South Sudan"
                           , adm_lvl = "adm2") %>% 
  st_transform(crs = crs)

SS_admin <- sf::st_join(states, SSudan)

SS_admin <- sf::st_join(districts, SS_admin)

#Download places - the ne_download #call isn't working. Using the url to #download manually.
#places <- ne_download(scale = 10
#                      , type = #"populated_places"
#                      , returnclass = #"sf")

#unzip the files and then read them 
#unzip("data/ne_10m_populated_places.z#ip", exdir = "data/places")

places <- st_read("data/places/ne_10m_populated_places.shp")

#filter for only South Sudan
places_SS <- places %>% 
  filter(SOV0NAME == "South Sudan") %>% 
  st_as_sf(coords = c("LONGITUDE", "LATITUDE")
           , crs = 4326) 
  
places_SS$FEATURECLA <- case_when(places_SS$FEATURECLA == "Populated place" ~ "city"
                                  , places_SS$FEATURECLA != "Populated place" ~ "capital") %>%
  as.factor()
  

#download water
#water <- ne_download(scale = 10
#                     , type = #"rivers_lake_centerlines"
#                     , category = #"physical"
 #                    , returnclass = #"sf") 

#unzip rivers file and read it in
#unzip("data/ne_10m_rivers_lake_center#lines.zip", exdir = "data/rivers")

water <- st_read("data/rivers/ne_10m_rivers_lake_centerlines.shp")

#filter for the region
water_SS <- water[neighbors,]

#download lakes
#lakes <- ne_download(scale = 10
#                     , type = "lakes"
#                     , category = #"physical"
#                     , returnclass = #"sf") 

#unzip lakes files and read in
#unzip("data/ne_10m_lakes.zip", exdir #= "data/lakes")

lakes <- st_read("data/lakes/ne_10m_lakes.shp")

```
ACLED's conflict event data from South Sudan dates from July 14, 2011 and goes through December 2, 2021. It includes 7,939 unique conflict events.

ACLED's conflict event data from South Sudan dates from July 14, 2011 and, at the time of download, goes through December 2, 2021. It includes 7,939 unique conflict events.

```{r, fig.width=12, fig.height=12, fig.cap = "Conflict events in South Sudan since its inception as a country."}

#A map of all conflict events plotted
map_points <- ggplot(data = neighbors_v1)+
  geom_sf(fill = "#F8F0E3") +
    geom_sf_label(data = neighbors_v1
                , aes(label = shapeName)) +
  geom_sf(data = states,
          color = "white") +
  geom_sf(data = events_sf
          , aes(color = event_type)
          , alpha = .3)+
  geom_sf_text(data = states
                , aes(label = shapeName)
                , color = "#565656") +
  geom_sf(data = SSudan
          , color = "#000000"
          , width = 4
          , fill = NA) +
  geom_sf(data = places_SS)+
  geom_sf_text(data = places_SS
                , aes(label = NAME_ID)
                , nudge_x = .2
                , nudge_y = -.1
                , check_overlap = T
                , color = "#000000")+
  geom_sf(data = water
          , color = "steel blue"
          , width = 4) +
  geom_sf(data = lakes
          , color = "steel blue"
          , width = 10)+
  coord_sf(xlim = c(bbox[[1]], bbox[[3]])
           , ylim = c(bbox[[2]], bbox[[4]]))+
  theme.plot()+
  labs(title = "South Sudan"
         , subtitle = "Event Points as geocoded"
         , caption = "Author: Brian Calhoon; Sources: ACLED, rgeoboundaries, rnaturalearth"
       , x = ""
       , y = "")+
  theme(axis.text = element_blank())

#A map of the country with all conflict events plotted and jittered
map_jitter <- ggplot(data = neighbors_v1)+
  geom_sf(fill = "#F8F0E3") +
    geom_sf_label(data = neighbors_v1
                , aes(label = shapeName)) +
  geom_sf(data = states,
          color = "white") +
  geom_sf(data = st_jitter(events_sf) #Adding in the jittering to see all the points
          , aes(color = event_type)
          , alpha = .3)+
  geom_sf_text(data = states
                , aes(label = shapeName)
                , color = "#565656") +
  geom_sf(data = SSudan
          , color = "#000000"
          , width = 4
          , fill = NA) +
  geom_sf(data = places_SS)+
  geom_sf_text(data = places_SS
                , aes(label = NAME_ID)
                , nudge_x = .2
                , nudge_y = -.1
                , check_overlap = T
                , color = "#000000")+
  geom_sf(data = water
          , color = "steel blue"
          , width = 4) +
  geom_sf(data = lakes
          , color = "steel blue"
          , width = 10)+
  coord_sf(xlim = c(bbox[[1]], bbox[[3]])
           , ylim = c(bbox[[2]], bbox[[4]]))+
  theme.plot()+
  labs(title = "South Sudan"
         , subtitle = "Event Points Jittered"
         , caption = "Author: Brian Calhoon; Sources: ACLED, rgeoboundaries, rnaturalearth"
       , x = ""
       , y = "")+
  theme(axis.text = element_blank())

#Same map but rasterized

raster_template <- rast(ext(SSudan), resolution = 20000,
                       crs = st_crs(events_sf)$wkt)

raster1 <- rasterize(vect(events_sf)
                    , raster_template
                    ,  fun = "length")

raster2 <- terra::as.data.frame(raster1
                                , xy=TRUE
                                , cells = TRUE) %>% 
  select(cell, x, y, Events = lyr.1)  


map_raster <- ggplot(data = neighbors_v1)+
  geom_sf(fill = "#F8F0E3") +
  geom_sf_label(data = neighbors_v1
                , aes(label = shapeName)) +
  geom_sf(data = states,
          color = "white") +
  geom_tile(data = raster2 #the raster object
          , aes(x = x
                , y = y
                , fill = Events))+
  geom_sf_text(data = states
               , aes(label = shapeName)
               , color = "#565656") +
  geom_sf(data = SSudan
          , color = "#000000"
          , size = 1
          , fill = NA) +
  geom_sf(data = places_SS)+
  geom_sf_text(data = places_SS
               , aes(label = NAME_ID)
               , nudge_x = .2
               , nudge_y = -.1
               , check_overlap = T
               , color = "#000000")+
  geom_sf(data = water
          , color = "steel blue") +
  geom_sf(data = lakes
          , color = "steel blue")+
  coord_sf(xlim = c(bbox[[1]], bbox[[3]])
           , ylim = c(bbox[[2]], bbox[[4]]))+
  theme.plot()+
  scale_fill_gradient(low = "#ffc6c4"
                      , high = "#672044"
                      , trans =  "log10")+
  labs(title = "South Sudan"
       , subtitle = "Logged-count of conflict events, 20 km grids"
       , caption = "Author: Brian Calhoon; Sources: ACLED, rgeoboundaries, rnaturalearth, terra"
       , x = ""
       , y = "")+
  theme(axis.text = element_blank())
  
#patch <- map_points - map_jitter

#patch2 <- map_raster - grid::textGrob("insert the nationwide district map that is currently below")

patchwork::wrap_plots(map_points, map_jitter, map_raster, grid::textGrob("Insert the Concentration of Conflict in South Sudan map"))
```

```{r fig.dim = c(10, 8)}

a <-st_join(SS_admin, events_sf, left = T)

#Choropleth map of counties and conflict
a %>% 
  group_by(shapeName) %>% 
  summarize(attacks = log1p(sum(!is.na(event_id_cnty)))) %>% 
  tmap::tm_shape() +
  tmap::tm_polygons('attacks', title = 'ACLED\nevents (logged)'
                    , style = "cont"
  #, palette = cont_pal
  , border.col = "white") +
  tmap::tm_shape(states)+
  tmap::tm_borders(col = "white"
             , lwd = 2)+
  tmap::tm_shape(st_union(a)) +
  tmap::tm_borders(col = "black"
             , lwd = 2)+
  tmap::tm_layout(main.title = "Concentration of Conflict in South Sudan, 2011 - 2021"
                  , fontfamily = "Corbel"
                  , legend.outside.position = "bottom"
                  , legend.position = c(0,0)) +
  tmap::tm_credits("Source: ACLED")
```

```{r, fig.width = 10, fig.height =12, fig.cap = "Conflict varies over time across South Sudan. With events concentrating over time in Central Equatoria."}

a <- a %>%  
  group_by(shapeName, year) %>% 
  summarize(attacks = log1p(sum(!is.na(event_id_cnty))))

tmap::tmap_mode("plot")+
  tmap::tm_shape(a
                 , is.master = T) +
  tmap::tm_polygons("attacks"
                    , title = "ACLED\nevents (logged)"
                    , border.col = "grey"
                    , style = "cont") +
  tmap::tm_facets("year") + 
  tmap::tm_shape(st_union(a))+
  tmap::tm_borders(col = "black")+
  tmap::tm_layout(main.title = "Conflict Concentration by Year, 2011 - 2021"
                  , legend.outside.position = "bottom", legend.position = c(0, 0)) #.8, 1.1

```



# An interactive map
Below is a map that you can explore for yourself. If you hover over one of the dots a label will appear, and if you click on it additional information about the event will appear.

```{r, fig.cap = "An interactive map of all conflicts in South Sudan."}
#tmap::tmap_mode("view")
#tmap::tm_basemap(c(StreetMap = #"OpenStreetMap",
#             TopoMap = #"OpenTopoMap")) +
#  tmap::tm_tiles(c(TonerHybrid = #"Stamen.TonerHybrid"))+
#  tmap::tm_shape(events_sf, is.master #= TRUE) + 
#  tmap::tm_dots(col = "event_type"
#          , id = "event_type"
#          , popup.vars=c("Event date" #= "event_date"
#                         , "Sub-event #Type"="sub_event_type"
#                         , "Actors"= #"actor1"
#                         , "Actors" = #"actor2"
#                         , #"Fatalities" = "fatalities"
#                         , "Sources" #= "source")
#          , popup.format=list() 
#          , group = "Events"
#          , jitter = .2
#          , alpha = .3
#          , palette = my_pal)
```
